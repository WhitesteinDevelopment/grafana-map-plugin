{"version":3,"sources":["../../src/utils/map_utils.js"],"names":["Highcharts","drawPopups","panelId","lastValueMeasure","validatedMetrics","hideAllGraphPopups","document","querySelector","options","length","drawMeasuresPopup","type","aqiIndex","calculateAQIIndex","value","getElementById","style","display","drawHealthConcernsPopup","AQI","risks","color","meaning","drawTrafficFlowPopup","drawDefaultPopups","error","console","log","drawSelect","metricsToShow","providedMetrics","currentParameterForChart","el","firstChild","removeChild","metricsKeys","Object","keys","emptyOption","createElement","id","title","innerHTML","selected","appendChild","forEach","metric","elem","newMetric","toUpperCase","selectBox","renderChart","selectedPointData","measurementUnits","chartDetails","debug","pointId","fieldName","drawChartCointainer","chartData","map","convertDate","created_at","toLowerCase","getChartMetaInfo","props","AirQualityObserved","TrafficFlowObserved","units","chartInfo","config","bootData","user","lightTheme","theme","HIGHCHARTS_THEME_DARK","setOptions","chart","height","zoomType","events","load","series","text","subtitle","xAxis","yAxis","legend","enabled","name","data","getDataPointExtraFields","dataPoint","values","fillOpacity","aqiColor","fillColor","aqiMeaning","aqiRisk","aqi","markerColor","colorIndex","calculateCarsIntensityIndex","CARS_COUNT","getMapMarkerClassName","resp","classColor","getDataPointStickyInfo","metricsTranslations","dataPointExtraFields","stickyInfo","getDataPointDetails","join","withoutGeojson","filter","key","translatedValues","dpKey","dP","Date","toLocaleString","trans","unit","translatedValue","getSelectedCity","vars","selectedVarName","cityEnv","city","current","map_table_popups","map_table_popup","popup","risk","map_size","healthConcernsWrapper","healthConcerns","healthConcernsColor","healthRisk","backgroundColor","measuresTable","rows","deleteRow","row","insertRow","innerCell0","innerCell1","cell0","insertCell","cell1","getCityCoordinates","city_name","url","NOMINATIM_ADDRESS","replace","fetch","then","response","json","latitude","lat","longitude","lon","catch","range","index","time_","time","day","getDate","month","getMonth","year","getFullYear","hour","getHours","minutes","getMinutes","seconds","getSeconds","milliseconds","getMilliseconds","UTC","geolocationOptions","enableHighAccuracy","timeout","maximumAge"],"mappings":"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","file":"map_utils.js","sourcesContent":["// draw components in the map\r\n/* Vendor specific */\r\nimport { defaults, isEqual } from 'lodash';\r\n\r\nimport Highcharts from \"../vendor/highcharts/highcharts\";\r\nimport Exporting from '../vendor/highcharts/modules/exporting';\r\n// Initialize exporting module.\r\nExporting(Highcharts);\r\n\r\n/* Grafana Specific */\r\nimport config from 'app/core/config';\r\n\r\nimport { titleize } from './string'\r\n\r\n/* App specific */\r\nimport { AQI, CARS_COUNT, NOMINATIM_ADDRESS } from '../definitions';\r\nimport { HIGHCHARTS_THEME_DARK } from '../utils/highcharts/custom_themes';\r\n\r\n\r\n/*\r\n* Primary functions\r\n*/\r\n\r\n/**\r\n* Display popups based in the click in map's marker\r\n*/\r\nfunction drawPopups(panelId, lastValueMeasure, validatedMetrics) {\r\n\r\n  //render popups\r\n  try {\r\n    // Show Metrics Legend (MAP)\r\n\r\n    //draw select\r\n    if(validatedMetrics) {\r\n\r\n      hideAllGraphPopups(panelId)\r\n\r\n      if(document.querySelector('#parameters_dropdown_'+panelId).options.length>1)\r\n        drawMeasuresPopup(panelId, lastValueMeasure, validatedMetrics)\r\n\r\n      switch(lastValueMeasure.type) {\r\n        case 'AirQualityObserved':\r\n          let aqiIndex = calculateAQIIndex(lastValueMeasure.value);\r\n          \r\n          document.getElementById('environment_table_'+panelId).style.display = 'block';\r\n\r\n          drawHealthConcernsPopup(panelId, AQI.risks[aqiIndex], AQI.color[aqiIndex], AQI.meaning[aqiIndex]);\r\n     \r\n          break;\r\n        case 'TrafficFlowObserved':\r\n          drawTrafficFlowPopup(panelId);\r\n          break;\r\n        default:\r\n          drawDefaultPopups(panelId);\r\n      }\r\n    }\r\n    \r\n  } catch(error) {\r\n    console.log(\"Error:\");\r\n    console.log(error);\r\n    console.log(\"lastValueMeasure: \")\r\n    console.log(lastValueMeasure)\r\n  }\r\n}\r\n/*\r\n* Draw the select box in the specific panel, with the specif metrics and select the option\r\n*/\r\nfunction drawSelect(panelId, metricsToShow, providedMetrics, currentParameterForChart) {\r\n  // Remove air paramters from dropdown\r\n  let el = document.querySelector('#parameters_dropdown_'+panelId);\r\n  while ( el.firstChild ) {\r\n    el.removeChild( el.firstChild )\r\n  }\r\n\r\n  let metricsKeys = Object.keys(metricsToShow)\r\n\r\n  //default option\r\n  let emptyOption = document.createElement('option');\r\n  emptyOption.id = 'metricsOption_'+panelId;\r\n  emptyOption.value = 'value';\r\n  emptyOption.title = \"Select this to see the default field values\"\r\n  emptyOption.innerHTML = 'Select Metric';\r\n  if(metricsKeys.length===0)\r\n    emptyOption.selected = 'selected';\r\n  el.appendChild(emptyOption);\r\n\r\n  //select population\r\n  metricsKeys.forEach((metric)=>{\r\n    providedMetrics.forEach((elem)=>{\r\n      if(elem[0] == metric) {\r\n        let newMetric = document.createElement('option');\r\n        newMetric.id = 'metricsOption_'+panelId;\r\n        newMetric.value = metric.toUpperCase();\r\n\r\n        if(currentParameterForChart===newMetric.value)\r\n          newMetric.selected = 'selected';\r\n        \r\n        newMetric.innerHTML = elem[1]?elem[1]:titleize(elem[0]);\r\n\r\n        el.appendChild(newMetric);\r\n      }\r\n    })\r\n  })\r\n  \r\n  let selectBox = document.querySelector('#parameters_dropdown_'+panelId)\r\n  if(selectBox.options.length>0)\r\n    selectBox.style.display = 'block';\r\n}\r\n/**\r\n* Render's the chart in panel\r\n*/\r\nfunction renderChart(panelId, selectedPointData, measurementUnits, chartDetails) {\r\n  console.debug('renderChart')\r\n  let [type, pointId, fieldName] = chartDetails\r\n\r\n  drawChartCointainer(panelId);\r\n\r\n  //prepare data to chart\r\n  let chartData = selectedPointData.map((elem)=>[ convertDate(elem.created_at), elem[fieldName.toLowerCase()] ]);\r\n\r\n  function getChartMetaInfo() {\r\n    let props = {\r\n      AirQualityObserved: 'Air Quality',\r\n      TrafficFlowObserved: 'Cars'\r\n    }\r\n\r\n    return { \r\n        title: `${props[type]||type}: Device ${pointId} - ${measurementUnits[1]?measurementUnits[1]:titleize(measurementUnits[0])}`,\r\n        units: (measurementUnits[2] ? `${measurementUnits[1]} (${measurementUnits[2]})` : measurementUnits[1])\r\n      }\r\n  }\r\n\r\n  let chartInfo = getChartMetaInfo();\r\n  \r\n  //config highchart acording with grafana theme\r\n  if(!config.bootData.user.lightTheme) {\r\n    Highcharts.theme = HIGHCHARTS_THEME_DARK;\r\n\r\n    // Apply the theme\r\n    Highcharts.setOptions(Highcharts.theme);\r\n  }\r\n\r\n  // let chart = angular.element(\r\n  //     document.getElementById('graph_container_'+panelId)\r\n  // ).highcharts();\r\n\r\n  Highcharts.chart('graph_container_'+panelId,\r\n    {\r\n      chart: {\r\n        type: 'line',\r\n        height: 200,\r\n        zoomType: 'x',\r\n        events: {\r\n          load: function () {            \r\n            chartData = this.series[0]; // set up the updating of the chart each second\r\n          }\r\n        }\r\n      },\r\n      title: {\r\n        text: chartInfo.title\r\n      },\r\n      subtitle: {\r\n        text: ''\r\n      },\r\n      xAxis: {\r\n        type: 'datetime'\r\n      },\r\n      yAxis: {\r\n        title: {\r\n          text: chartInfo.units\r\n        }\r\n      },\r\n      legend: {\r\n        enabled: false\r\n      },\r\n      series: [{\r\n        name: chartInfo.units,\r\n        data: chartData\r\n      }]\r\n    }\r\n  );\r\n}\r\n\r\n\r\n/**\r\n* private functions\r\n*/\r\nfunction getDataPointExtraFields(dataPoint) {\r\n\r\n  const values = {\r\n    fillOpacity: 0.5\r\n  }\r\n\r\n  if(dataPoint.type==='AirQualityObserved') {\r\n    let aqiIndex = calculateAQIIndex(dataPoint.value);\r\n    let aqiColor = AQI.color[aqiIndex];\r\n\r\n    defaults(values, {\r\n      color: aqiColor,\r\n      fillColor: aqiColor,\r\n\r\n      aqiColor: aqiColor,\r\n      aqiMeaning: AQI.meaning[aqiIndex],\r\n      aqiRisk: AQI.risks[aqiIndex],\r\n      aqi: dataPoint.value,\r\n\r\n      markerColor: AQI.markerColor[aqiIndex]\r\n    })    \r\n  } else {\r\n    if(dataPoint.type==='TrafficFlowObserved') {\r\n      let colorIndex = calculateCarsIntensityIndex(dataPoint.value)\r\n\r\n      defaults(values, {\r\n        color: CARS_COUNT.color[colorIndex], \r\n        fillColor: CARS_COUNT.color[colorIndex],\r\n        \r\n        markerColor: CARS_COUNT.markerColor[colorIndex]\r\n      })\r\n    }\r\n  }\r\n\r\n  return values;\r\n}\r\n\r\nfunction getMapMarkerClassName(type, value) {\r\n  let resp = 'map-marker-';\r\n  if(type==='AirQualityObserved') {\r\n    return resp+AQI.classColor[calculateAQIIndex(value)];\r\n  } else if(type==='TrafficFlowObserved')\r\n    return resp+CARS_COUNT.classColor[calculateCarsIntensityIndex(value)];\r\n  return resp+'default';\r\n}\r\n\r\nfunction getDataPointStickyInfo(dataPoint, metricsTranslations) {\r\n  let dataPointExtraFields = getDataPointExtraFields(dataPoint);  \r\n  let stickyInfo = '<div class=\"stycky-popup-info\">';\r\n\r\n  if(dataPoint.type==='AirQualityObserved') {\r\n    stickyInfo += '<div class=\"head air-quality\">Air Quality</div>';\r\n  } else {\r\n    if(dataPoint.type==='TrafficFlowObserved') {\r\n      stickyInfo += '<div class=\"head traffic-flow\">Cars Intensity</div>';\r\n    } else {\r\n      stickyInfo += '<div class=\"head\">' + dataPoint.type + '</div>';\r\n    }\r\n  }  \r\n\r\n  //body\r\n  stickyInfo += '<div class=\"body\">';\r\n  stickyInfo += getDataPointDetails(dataPoint, metricsTranslations).join('');\r\n  stickyInfo += '</div>';\r\n  stickyInfo += '</div>';\r\n\r\n  //console.debug(dataPoint)\r\n  return stickyInfo\r\n}\r\n\r\nfunction getDataPointDetails(dataPoint, metricsTranslations) {\r\n  const withoutGeojson = Object.keys(dataPoint).filter((key) => key !== 'geojson');\r\n  let translatedValues = withoutGeojson.map((dpKey)=>{\r\n    let dP = (dpKey==='created_at'?new Date(dataPoint[dpKey]).toLocaleString():dataPoint[dpKey]);\r\n    let trans = metricsTranslations.filter((elem)=>elem[0]===dpKey);\r\n    return { 'name': (trans.length>0 && trans[0][1] ? trans[0][1] : titleize(dpKey) ), value: dP||'-', unit: (trans.length>0 ? trans[0][2] : '') }\r\n  })\r\n  //creation of html row\r\n  return translatedValues.map((translatedValue)=>`<div><span>${translatedValue.name}</span><span>${translatedValue.value} ${translatedValue.unit||''}</span></div>`)\r\n}\r\n\r\n//show all accepted metrics for a specific point id\r\n// function getMetricsToShow(allMetrics, id) {\r\n//   const metricsToShow = {};\r\n//   for (const key in allMetrics) {\r\n//     allMetrics[key].forEach((_value) => {\r\n//       if (_value.id === id) {\r\n//         if (_value.value) {\r\n//           if (!(metricsToShow[key])){\r\n//             metricsToShow[key] = 0;\r\n//           }\r\n//           metricsToShow[key] = _value.value;\r\n//         }\r\n//       }\r\n//     });\r\n//   }\r\n\r\n//   //  metricsToShow['aqi'] = aqi;\r\n//   return metricsToShow\r\n// }\r\n\r\n// Given vars passed as param, retrieves the selected city\r\nfunction getSelectedCity(vars, selectedVarName) {\r\n  let cityEnv = vars.filter(elem => elem.name===selectedVarName)\r\n\r\n  let city = null;\r\n  if(cityEnv && cityEnv.length === 1)\r\n    city = cityEnv[0].current.value;\r\n\r\n  return city;\r\n}\r\n\r\nfunction hideAllGraphPopups(panelId) {\r\n  let map_table_popups = ['measures_table', 'health_concerns_wrapper', 'environment_table', 'traffic_table'];\r\n\r\n  for(let map_table_popup of map_table_popups) {\r\n    let popup = document.getElementById(map_table_popup+'_'+panelId);\r\n    if(popup)\r\n      popup.style.display = 'none';\r\n  }\r\n}\r\n\r\nfunction drawDefaultPopups() {  \r\n}\r\n/*\r\n* Draw Traffic Flow Popup\r\n*/\r\nfunction drawTrafficFlowPopup(panelId) {\r\n  document.getElementById('traffic_table_'+panelId).style.display = 'block';\r\n}\r\n/*\r\n* Draw Health Concerns Popup\r\n*/\r\nfunction drawHealthConcernsPopup(panelId, risk, color, meaning, map_size) {\r\n  const healthConcernsWrapper = document.getElementById('health_concerns_wrapper_'+panelId);\r\n  const healthConcerns = document.querySelector('#health_concerns_wrapper_'+panelId+'>div');\r\n  const healthConcernsColor = document.querySelector('#health_concerns_wrapper_'+panelId+'>div>span>span.color');\r\n  const healthRisk = document.getElementById('health_risk_'+panelId);\r\n\r\n  healthConcernsWrapper.style.display = 'block';\r\n  healthConcernsColor.style.backgroundColor = color;\r\n  healthRisk.innerHTML = risk;\r\n}\r\n/*\r\n* Draw Measures Popup - The popup info is related with the choosed value \r\n*  from select box and with the metrics that came from result set\r\n*  and from a list of what to show metrics\r\n*/\r\nfunction drawMeasuresPopup(panelId, metricsToShow, providedMetrics) {\r\n  const measuresTable = document.querySelector('#measures_table_'+panelId+' > table > tbody');\r\n  while (measuresTable.rows[0]) measuresTable.deleteRow(0);\r\n\r\n  Object.keys(metricsToShow).forEach((metric)=>{\r\n    providedMetrics.forEach((elem)=>{\r\n      if(elem[0] == metric) {\r\n        let row = measuresTable.insertRow();    // -1 for inserting bottom\r\n        let innerCell0 = elem[1]?elem[1]:titleize(elem[0]);\r\n        let innerCell1 = (metricsToShow[metric] ? metricsToShow[metric] : '-') + (elem[2]?` ${elem[2]}`:'');\r\n        let cell0 = row.insertCell(0);\r\n        let cell1 = row.insertCell(1);\r\n\r\n        cell0.innerHTML = innerCell0;\r\n        cell1.innerHTML = innerCell1;        \r\n      }\r\n    })\r\n\r\n  })\r\n\r\n  document.getElementById('measures_table_'+panelId).style.display = 'block';\r\n}\r\n/*\r\n* Draw Chart\r\n*/\r\nfunction drawChartCointainer(panelId) {\r\n  document.querySelector('#data_details_'+panelId).style.display = 'block';\r\n  document.getElementById('data_chart_'+panelId).style.display = 'block';\r\n}\r\n\r\n// Access remote api and gives the coordinates from a city center based on NOMINATIM url server\r\nfunction getCityCoordinates(city_name) {\r\n  let url = NOMINATIM_ADDRESS.replace('<city_name>', city_name)\r\n  return fetch(url)\r\n    .then(response => response.json())\r\n    .then(data => { return { latitude: data[0].lat, longitude: data[0].lon } })\r\n    .catch(error => console.error(error))\r\n}\r\n\r\n// gets the aqi index from the AQI var\r\nfunction calculateAQIIndex(value) {\r\n  let aqiIndex;\r\n  AQI.range.forEach((elem, index) => {\r\n    if (value >= elem) {\r\n      aqiIndex = index;\r\n    }\r\n  });\r\n  return aqiIndex;\r\n}\r\n// gets the index from the CARS_COUNT const var\r\nfunction calculateCarsIntensityIndex(value) {\r\n  CARS_COUNT.range.forEach((elem, index) => {\r\n    if (value >= elem) {\r\n      return index;\r\n    }\r\n  });\r\n  return 0;\r\n}\r\n\r\n/*\r\n* Auxiliar functions\r\n*/\r\n// just for improve DRY\r\nfunction convertDate(time_) {\r\n  const time = new Date(time_);\r\n  const day = time.getDate();\r\n  const month = time.getMonth();\r\n  const year = time.getFullYear();\r\n  const hour = time.getHours() - 1;\r\n  const minutes = time.getMinutes();\r\n  const seconds = time.getSeconds();\r\n  const milliseconds = time.getMilliseconds();\r\n  return Date.UTC(year, month, day, hour+1, minutes, seconds, milliseconds)\r\n}\r\n\r\nvar geolocationOptions = {\r\n  enableHighAccuracy: true,\r\n  timeout: 5000,\r\n  maximumAge: 110\r\n};\r\n\r\nexport {\r\n\r\n  hideAllGraphPopups, \r\n  drawPopups,\r\n  drawSelect,\r\n  renderChart,\r\n\r\n  getCityCoordinates,\r\n\r\n  getDataPointExtraFields,\r\n  getDataPointStickyInfo,\r\n\r\n  getSelectedCity,\r\n\r\n  getMapMarkerClassName,\r\n\r\n  geolocationOptions\r\n}"]}